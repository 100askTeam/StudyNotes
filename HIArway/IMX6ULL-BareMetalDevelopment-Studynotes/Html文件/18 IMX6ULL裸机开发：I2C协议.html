<html>
<head>
  <title>18 IMX6ULL裸机开发：I2C协议</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605138 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 12pt;
    }
  </style>
</head>
<body>
<a name="2351"/>
<h1>18 IMX6ULL裸机开发：I2C协议</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2022/2/23 10:25</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2022/2/23 14:15</i></td></tr>
<tr><td><b>作者：</b></td><td><i>gi51wa2j</i></td></tr>
<tr><td><b>标签：</b></td><td><i>100ask_IMX6ULL_v11, bingo, 正文</i></td></tr>
</table>
</div>
<br/>

<div><span><h1>一、参考资料</h1><a href="18 IMX6ULL裸机开发：I2C协议_files/3_I2C总线协议手册.pdf"><img src="18 IMX6ULL裸机开发：I2C协议_files/e9530e37b76ca17726aa28cc9cb3e616.png" alt="3_I2C总线协议手册.pdf"></a><a href="18 IMX6ULL裸机开发：I2C协议_files/i2c_spec.pdf"><img src="18 IMX6ULL裸机开发：I2C协议_files/18bb1eb2ea81baa5b8cf833dea36408e.png" alt="i2c_spec.pdf"></a><div><br/></div><h1>二、硬件连接</h1><p style="text-align:start;">I2C在硬件上的接法如下所示，主控芯片引出两条线SCL,SDA线，在一条I2C总线上可以接很多I2C设备，我们还会放一个上拉电阻（放一个上拉电阻的原因以后我们再说）。</p><img src="18 IMX6ULL裸机开发：I2C协议_files/Image.png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;"/><h1>三、 传输数据类比</h1><p style="text-align:start;">怎么通过I2C传输数据，我们需要把数据从主设备发送到从设备上去，也需要把数据从从设备传送到主设备上去，数据涉及到双向传输。</p><p style="text-align:start;">举个例子：</p><img src="18 IMX6ULL裸机开发：I2C协议_files/Image [1].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;"/><p style="text-align:start;">体育老师：可以把球发给学生，也可以把球从学生中接过来。</p><ul><li><p>发球：</p></li><ul><li><p>老师：开始了(start)</p></li><li><p>老师：A！我要发球给你！(地址/方向)</p></li><li><p>学生A：到！(回应)</p></li><li><p>老师把球发出去（传输）</p></li><li><p>A收到球之后，应该告诉老师一声（回应）</p></li><li><p>老师：结束（停止）</p></li></ul><li><p>接球：</p></li><ul><li><p>老师：开始了(start)</p></li><li><p>老师：B！把球发给我！(地址/方向)</p></li><li><p>学生B：到！</p></li><li><p>B把球发给老师（传输）</p></li><li><p>老师收到球之后，给B说一声，表示收到球了（回应）</p></li><li><p>老师：结束（停止）</p></li></ul></ul><p style="text-align:start;">我们就使用这个简单的例子，来解释一下IIC的传输协议：</p><ul><li><p>老师说开始了，表示开始信号(start)</p></li><li><p>老师提醒某个学生要发球，表示发送地址和方向(address/read/write)</p></li><li><p>老师发球/接球，表示数据的传输</p></li><li><p>收到球要回应：回应信号(ACK)</p></li><li><p>老师说结束，表示IIC传输结束(P)</p></li></ul><h1>四、 IIC传输数据的格式</h1><h2>4.1 写操作</h2><p style="text-align:start;">流程如下：</p><ul><li><p>主芯片要发出一个start信号</p></li><li><p>然后发出一个设备地址(用来确定是往哪一个芯片写数据)，方向(读/写，0表示写，1表示读)</p></li><li><p>从设备回应(用来确定这个设备是否存在)，然后就可以传输数据</p></li><li><p>主设备发送一个字节数据给从设备，并等待回应</p></li><li><p>每传输一字节数据，接收方要有一个回应信号（确定数据是否接受完成)，然后再传输下一个数据。</p></li><li><p>数据发送完之后，主芯片就会发送一个停止信号。</p></li></ul><p style="text-align:start;">下图：白色背景表示&quot;主→从&quot;，灰色背景表示&quot;从→主&quot;</p><img src="18 IMX6ULL裸机开发：I2C协议_files/Image [2].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;"/><h2>4.2 读操作</h2><p style="text-align:start;">流程如下：</p><ul><li><p>主芯片要发出一个start信号</p></li><li><p>然后发出一个设备地址(用来确定是往哪一个芯片写数据)，方向(读/写，0表示写，1表示读)</p></li><li><p>从设备回应(用来确定这个设备是否存在)，然后就可以传输数据</p></li><li><p>从设备发送一个字节数据给主设备，并等待回应</p></li><li><p>每传输一字节数据，接收方要有一个回应信号（确定数据是否接受完成)，然后再传输下一个数据。</p></li><li><p>数据发送完之后，主芯片就会发送一个停止信号。</p></li></ul><p style="text-align:start;">下图：白色背景表示&quot;主→从&quot;，灰色背景表示&quot;从→主&quot;</p><img src="18 IMX6ULL裸机开发：I2C协议_files/Image [3].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;"/><p style="text-align:start;"><br/></p><h2>4.3 I2C信号</h2><p style="text-align:start;">I2C协议中数据传输的单位是字节，也就是8位。但是要用到9个时钟：前面8个时钟用来传输8数据，第9个时钟用来传输回应信号。传输时，先传输最高位(MSB)。</p><ul><li><p>开始信号（S）：SCL为高电平时，SDA山高电平向低电平跳变，开始传送数据。</p></li><li><p>结束信号（P）：SCL为高电平时，SDA由低电平向高电平跳变，结束传送数据。</p></li><li><p>响应信号(ACK)：接收器在接收到8位数据后，在第9个时钟周期，拉低SDA</p></li><li><p><br/></p></li><li><p><b>等待SDA响应结束后，CLK拉低，等待一会数据处理的时间</b></p></li><li><p><br/></p></li><li><p><span style="color: #FF0000;"><b>SDA上传输的数据必须在SCL为高电平期间保持稳定，SDA上的数据只能在SCL为低电平期间变化</b></span></p></li></ul><p style="text-align:start;">I2C协议信号如下：</p><img src="18 IMX6ULL裸机开发：I2C协议_files/009_i2c_signal.png" type="image/png" data-filename="009_i2c_signal.png" style="--en-uploadstate:uploaded;"/><h2>4.4 协议细节</h2><ul><li><p>如何在SDA上实现双向传输？ 主芯片通过一根SDA线既可以把数据发给从设备，也可以从SDA上读取数据，连接SDA线的引脚里面必然有两个引脚（发送引脚/接受引脚）。</p></li><li><p>主、从设备都可以通过SDA发送数据，肯定不能同时发送数据，怎么错开时间？ 在9个时钟里， 前8个时钟由主设备发送数据的话，第9个时钟就由从设备发送数据； 前8个时钟由从设备发送数据的话，第9个时钟就由主设备发送数据。</p></li><li><p><b>双方设备中，某个设备发送数据时，另一方怎样才能不影响SDA上的数据？ </b></p></li><li><p>设备的SDA中有一个三极管，使用开极/开漏电路(三极管是开极，CMOS管是开漏，作用一样)，如下图： </p></li></ul><img src="18 IMX6ULL裸机开发：I2C协议_files/Image [4].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;"/><p style="text-align:start;">真值表如下： </p><img src="18 IMX6ULL裸机开发：I2C协议_files/Image [5].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="438px"/><p style="text-align:start;"><br/></p><p style="text-align:start;">从真值表和电路图我们可以知道：</p><ul><li><p>当某一个芯片不想影响SDA线时，那就不驱动这个三极管</p></li><li><p>想让SDA输出高电平，双方都不驱动三极管(SDA通过上拉电阻变为高电平)</p></li><li><p>想让SDA输出低电平，就驱动三极管</p></li></ul><p style="text-align:start;"><br/></p><p style="text-align:start;">从下面的例子可以看看数据是怎么传的（实现双向传输）。 举例：主设备发送（8bit）给从设备</p><ul><li><p>前8个clk</p></li><ul><li><p>从设备不要影响SDA，从设备不驱动三极管</p></li><li><p>主设备决定数据，主设备要发送1时不驱动三极管，要发送0时驱动三极管</p></li></ul><li><p>第9个clk，由从设备决定数据</p></li><ul><li><p>主设备不驱动三极管</p></li><li><p>从设备决定数据，要发出回应信号的话，就驱动三极管让SDA变为0</p></li><li><p>从这里也可以知道ACK信号是低电平</p></li></ul></ul><p style="text-align:start;"><br/></p><p style="text-align:start;">从上面的例子，就可以知道怎样在一条线上实现双向传输，这就是SDA上要使用上拉电阻的原因。</p><p style="text-align:start;"><br/></p><p style="text-align:start;"><span style="color: #FF0000;"><b>为何SCL也要使用上拉电阻？</b></span></p><p style="text-align:start;"> 在第9个时钟之后，如果有某一方需要更多的时间来处理数据，它可以一直驱动三极管把SCL拉低。 当SCL为低电平时候，大家都不应该使用IIC总线，只有当SCL从低电平变为高电平的时候，IIC总线才能被使用。 当它就绪后，就可以不再驱动三极管，这是上拉电阻把SCL变为高电平，其他设备就可以继续使用I2C总线了。</p><img src="18 IMX6ULL裸机开发：I2C协议_files/Image [6].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;"/><p style="text-align:start;"><span style="color: #FF0000;"><b>对于IIC协议它只能规定怎么传输数据，数据是什么含义由从设备决定。</b></span></p><h1>五、GPIO模拟I2C</h1><img src="18 IMX6ULL裸机开发：I2C协议_files/Image [7].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;"/><div><br/></div></span>
</div></body></html> 