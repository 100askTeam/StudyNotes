<html>
<head>
  <title>06 IMX6ULL裸机开发：IMX6ULL时钟体系</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605138 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <meta name="content-class" content="yinxiang.superNote"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 12pt;
    }
  </style>
</head>
<body>
<a name="756"/>
<h1>06 IMX6ULL裸机开发：IMX6ULL时钟体系</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2022/1/6 15:13</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2022/1/14 11:31</i></td></tr>
<tr><td><b>作者：</b></td><td><i>gi51wa2j</i></td></tr>
<tr><td><b>标签：</b></td><td><i>100ask_IMX6ULL_v11, bingo, 正文</i></td></tr>
</table>
</div>
<br/>

<div><span><h1>提前了解：</h1><div><span style="font-size: 12pt;"> </span>    <span style="font-size: 12pt;">本文仅对IMX6ULL时钟做一个简单介绍，其他相应的芯片时钟也可以对照该文章进行参考使用，但是具体的芯片使用还需要认真查看相应的芯片手册，根据时钟树来寻找对应寄存器设置。对于时钟的应用就是几个字：<span style="color: #FF0000;"><b>先倍频，再分频</b></span></span></div><h1>一、IMX6ULL时钟体系介绍</h1><h2><b>1.1 晶体振荡电路</b></h2><div><b>时钟信号不是凭空产生的，芯片首先需有一个频率较低的源时钟信号</b>。imx6ull包含两个偏压放大器（biased amplifier），当外部连接合适的晶振和负载电容时，能够分别产生<span style="background-color: #ffff00;"><b>24MHZ和32KHZ</b></span><b>的时钟信号</b>。</div><div>下面是开发板的时钟引脚连接原理图：</div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image.png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="738px"/><div><b> </b> <span style="background-color: #ffff00;">   <b>IIMX6ULL的时钟源有两个：24M外部晶振和32.768K晶振，</b></span><span style="color: #FF0000;"><span style="background-color: #ffff00;"><b>其中32.768K晶振用于内部RTC模块使用。24M外部晶振用于内核和各种外设使用，是时钟树的根源。</b></span></span></div><div>  <b>当imx6ull的时钟引脚XTALI和XTALO连上合适的晶振和电容时，模块XTALOSC24M会产生24MHZ的时钟信号</b>。<span style="color: #FF0000;"><b>注意，输出频率到达24MHZ并不意味着模块XTALOSC24M已经稳定工作，仍然需要等待一段时间</b>。</span>一旦时钟信号稳定，可以通过设置寄存器来降低它的工作电流；但是<span style="color: #FF0000;"><b>注意，在关闭模块XTALOSC24M电源之前，相应的值应当被恢复，否则恢复供电时模块不能正常启动</b>。</span></div><div>     另外，<b>imx6ull还有一个内置的24MHZ RC振荡器，它以RTC时钟（32KHZ）做基准产生时钟信号</b>。尽管能源消耗显著低于模块XTALOSC24M，但是它的<span style="color: #FF0000;">精确度存在较大误差</span>，实际应用中应当<span style="color: #FF0000;">避免使用</span>它。</div><div>     当imx6ull的时钟引脚RTC_XTALI和RTC_XTALO连接32KHZ或32.768KHZ的晶振时，用模块RTC_XTAL产生32KHZ的RTC时钟信号。 除此之外，<b>imx6ull还包含</b><span style="color: #FF0000;"><b>一个内部的32KHZ振荡器</b></span><b>，当时钟系统探测到</b><span style="color: #FF0000;"><b>RTC振荡器丢失时钟信号</b></span><b>时，会</b><span style="color: #FF0000;"><b>自动切换</b></span><b>到内部的 32KHZ振荡器</b>。但是由于该内部振荡器<span style="color: #FF0000;">精度不如</span>模块RTC_XTAL，不能作为替代品长时间使用。</div><div>     RTC时钟信号主要用来记录时间，而XTALOSC24M的输出时钟信号为芯片的时钟体系提供基础的源时钟信号，是本篇讨论的重点。</div><div>     除此之外，芯片本身也可以直接接收时钟信号作为源时钟信号，这需要芯片外部提供一个稳定的时钟信号源。这种方式较不常用，本文不再进行描述。</div><h2><b>1.2 锁相环电路（PLL）</b></h2><div><span style="background-color: #ffff00;">    XTALOSC24M的时钟信号只有24MHZ，远远不能满足实际需求，在芯片中需要进行</span><span style="color: #FF0000;"><span style="background-color: #ffff00;"><b>稳定和倍频操作，这主要是由锁相环电路完成的</b>。在生成7路PLL和8路PFD后，系统产生了足够的时钟源。</span></span></div><div><b>锁相环（PLL）由鉴相器PD、低通滤波器LPF和压控振荡器VCO组成</b>。鉴相器（PD）用来鉴别两个输入时钟信号之间的相位差，并输出误差电压，经过低通滤波（LPF）后，形成压控振荡器（VCO）的控制。压控振荡器的输出经过<b>分频（DIV</b>）后反馈到鉴相器与基准信号进行比较，最终，VCO的输出就会稳定下来。下图是锁相环工作原理示意图：</div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [1].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="615px"/><h3>1.2.1 7个PLL介绍</h3><div><span style="color: #FF0000;"><b>imx6ull包含7个锁相环电路，它们的输入时钟信号称为源时钟信号，可通过寄存器选择，通常为XTALOSC24M产生的24MHZ时钟信号</b>。</span>它们的输出经过进一步选择和分频，形成不同的根时钟信号，分发到各个模块使用。这些锁相环电路及它们的分频器输出如下图所示：</div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [2].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="801px"/><div>下面分别介绍这些PLL的功能。</div><ol><ol><li><div><span style="background-color: #ffff00;"><b>PLL1：</b></span></div></li></ol></ol><div>     <span style="color: #FF0000;">被称为ARM_PLL，用来驱动ARM核心工作。它能够倍频达到1.3GHZ</span>，注意这个频率超过了芯片能够工作的最大频率1GHZ。</div><ol><ol start="2"><li><div><span style="background-color: #ffff00;">PLL2：</span></div></li></ol></ol><div>     <span style="color: #FF0000;">被称为SYS_PLL或者528_PLL</span>。它的倍频参数固定在<b>x22</b>，在使用XTALOSC24M产生的24MHZ时钟作为参考时钟时，产生528MHZ的输出。<span style="color: #FF0000;">除了这个主输出，SYS_PLL还包含四个分频器，主输出和分频器的输出可用来作为根时钟</span>。SYS_PLL的这些输出时钟信号的频率并不需要是确定或者精确的值，可在<span style="color: #FF0000;">运行时动态进行改变</span>。通常，它们用来驱动芯片内部的系统总线，内部处理逻辑，DDR接口以及NAND/NOR等等。</div><ol><ol start="3"><li><div><span style="background-color: #ffff00;">PLL3：</span></div></li></ol></ol><div>    <span style="color: #FF0000;"> 被称为USB1_PLL，用来驱动第一个USB物理层实体USBPHY1</span>。它的倍频参数固定在<b>x20</b>，在使用24MHZ参考时钟时产生480MHZ的输出。<span style="color: #FF0000;">除了主输出之外，USB1_PLL同样包含四个分频器</span>，它们的<span style="color: #FF0000;">输出用来作为需要固定频率的根时钟</span>，比如UART和其它的串行接口，音频接口等。</div><ol><ol start="4"><li><div><span style="background-color: #ffff00;">PLL4：</span></div></li></ol></ol><div>     <span style="color: #FF0000;">被称为AUDIO_PLL，能够进行倍频和分频操作，产生低抖动、高精度标准<b>音频时钟信号</b></span>。AUIDIO_PLL的输出频率范围从650MHZ到1300MHZ，时钟的频率分辨率要好于1HZ。该输出时钟信号<span style="color: #FF0000;">主要用来驱动串行音频接口或者作为外部音频解码器的参考时钟</span>。另外，AUDIO_PLL的分频器，可对VCO的输出时钟信号进行/1、/2或/4分频。</div><ol><ol start="5"><li><div><span style="background-color: #ffff00;">PLL5：</span></div></li></ol></ol><div>    <span style="color: #FF0000;"> 被称为VIDEO_PLL。它同样具有倍频和分频功能，能够产生低抖动、高精度标准<b>视频时钟信号</b></span>。VIDEO_PLL的输出频率范围从650MHZ到1300MHZ，时钟的频率分辨率要好于1HZ。该输出时钟<span style="color: #FF0000;">主要作为显示和视频接口的时钟信号</span>。另外，VIDEO_PLL的分频器，可对VCO的输出时钟信号进行/1、/2、/4或/8分频。</div><ol><ol start="6"><li><div><span style="background-color: #ffff00;">PLL6：</span></div></li></ol></ol><div>    <span style="color: #FF0000;"> 被称为ENET_PLL</span>。它的倍频参数固定为<span style="color: #FF0000;"><b>x20+(5/6)</b></span>，在使用24MHZ参考时钟时产生500MHZ的输出。它主要用来生成：（1）50MHZ或25MHZ时钟，用于外部以太网接口；（2）125MHZ时钟，用于精简的千兆以太网接口；（3）100MHZ时钟，用于通用功能。</div><ol><ol start="7"><li><div><span style="background-color: #ffff00;">PLL7：</span></div></li></ol></ol><div>     <span style="color: #FF0000;">被称为USB2_PLL，专门用于驱动第二个USB物理层实体USBPHY2</span>。它的倍频参数固定为<b>x20</b>，输出480MHZ的时钟信号。</div><h3>1.2.2 锁相环电路的三种模式</h3><div><span style="background-color: #ffff00;"><b>上述锁相环电路都有自己专门的控制和状态寄存器，它们可独立配置为以下3个模式中的一种：</b></span></div><div style="padding-left:40px;">1)  <b>Bypass模式：</b>PLL输入的参考时钟直接传递到输出，由BYPASS位控制；</div><div style="padding-left:40px;">2)  <b>输出禁止模式：</b>无论bypass时钟还是PLL生成的时钟均被禁止，无输出时钟信号，由<span style="color: #FF0000;">ENABLE位</span>控制；</div><div style="padding-left:40px;">3)  <b>断电模式：</b>PLL中大部分电路断电，无输出时钟信号，由<span style="color: #FF0000;">POWERDOWN位</span>控制。</div><div>     以ARM_PLL为例，单独截取出来说明，见下图。<span style="color: #FF0000;">PLL正常工作时</span>，时钟信号通过路径1传输作为信号ref_armpll_clk输出；<span style="color: #FF0000;">处于Bypass模式时</span>，源时钟信号不经过PLL放大，由路径2直接输出；<span style="color: #FF0000;">处于输出禁止模式时</span>，时钟信号在armpll_enable处被屏蔽，ref_armpll_clk无输出；<span style="color: #FF0000;">处于断电模式时</span>，ARM_PLL大部分电路断电，电路不工作，ref_armpll_clk无输出信号。</div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [3].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="829px"/><div style="--en-blockquote:true;box-sizing: border-box; padding-left: 19px; padding-top: 6px; padding-bottom: 6px; border-left: 3px solid #b4c0cc; background-position: initial initial; background-repeat: initial initial; margin-top: 6px"><div>上图来自芯片手册：Figure 10-3. Primary Clock Generation </div></div><div>    其中，两个锁相环电路<b>SYS_PLL和USB1_PLL</b>，分别带有四个分相器（PFD）对其产生的PLL输出信号进行分频（<span style="color: #FF0000;"><span style="background-color: #ffff00;">每个分相器可<b>独立</b>设置分频参数</span></span>），用来产生额外的频率输出。<b>由于分相器完全由数字器件组成且不包含反馈回路，我们只需要改变逻辑组合就能改变分频参数的值，不影响锁相环电路的锁定状态，因此</b><span style="color: #FF0000;"><b>分相器能够比锁相环更快的改变输出频率</b></span>。除此之外，<span style="color: #FF0000;"><b>分相器的值还能在运行时改变，不需要在改变前后关闭和开启时钟的输出。</b></span></div><div>     注意，对于那些包含分相器的锁相环电路，<span style="color: #FF0000;"><span style="background-color: #ffff00;">每个分相器有自己<b>独立的时钟屏蔽控制位</b></span></span>。<b>当相连的锁相环电路加电启动或者重新锁定时，分相器自动进入屏蔽状态，需要手动对每个PFD进行一次屏蔽和开启操作。</b></div><div><br/></div><h2><b>1.3 根时钟信号电路</b></h2><div>    <span style="background-color: #ffff00;"><b>在生成7路PLL和8路PFD后，系统产生了足够的时钟源，但是如何供给外设使用呢，这就需要CLOCK ROOT GENERATOR牵线搭桥。其作用就是根据实际需要，选择合适的时钟源，并对其进行分频，倍频，切换等工作，从而让外设拥有合适的时钟源</b></span></div><div>     如前所述，<span style="color: #FF0000;"><b>锁相环电路的输出时钟信号并不能直接供其它模块使用</b></span>。<b>在imx6ull中，它们的输出时钟信号、PFD时钟信号以及对应的bypass时钟信号经过选择、分频后形成根时钟信号，才会分发到各个模块。</b>这<span style="color: #FF0000;"><b>部分电路又细分为两部分</b></span>，前半部分称为<b>时钟切换电路（switcher）</b>，后半部分称为<b>根时钟生成电路（root generator）。</b></div><div>    <span style="background-color: #ffff00;"><b>时钟切换电路</b></span>主要对<b>PLL1和PLL3的输出进行选择</b>，被选中的信号形成pll1_sw_clk和pll3_sw_clk信号。另外，它还对<b>PLL4和PLL5进行额外的分频操作</b>，形成pll4_main_clk和pll5_main_clk信号。如下图所示：</div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [4].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="817px"/><div>    <span style="background-color: #ffff00;"><b>后续电路不直接使用上述PLL的输出，而是使用switcher形成的这些输出信号</b></span>。例如，如果我们<span style="color: #FF0000;">想改变CPU的工作频率</span>，可以先修改CCSR[pll1_sw_clk_sel]将<b>pll1_sw_clk切换到step_clk</b>，然后修改PLL1的参数，等待其输出时钟信号稳定到新的频率上，<b>再切换回PLL1的输出信号pll1_main_clk</b>。因为使用了无抖动的多路选择器（glitchless multiplexer），在切换过程中CPU仍正常运行，我们将在第一个编程示例中演示上述过程。</div><div>    <span style="background-color: #ffff00;">根时钟生成电路</span><span style="color: #FF0000;">对前面的这些信号和PLL2的输出信号进一步筛选和分频形成根时钟信号</span>，<span style="background-color: #ffff00;"><b>它们直接或者间接驱动芯片中的模块来实现各自功能。</b></span></div><div><b>这里仅以总线相关的根时钟信号进行说明，如下图所示：</b></div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [5].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="820px"/><div>其它的根时钟信号和模块对这些根时钟信号的使用参见CCM和模块各自的寄存器设置，这里不再展开叙述。<b>本章第二个编程示例计算锁相环电路输出时钟和这些总线的根时钟的频率并打印出来</b>，有兴趣的同学也可以参照示例代码和imx6ull手册计算其它的时钟信号的频率。 </div><h1>二、 寄存器介绍</h1><div>    <span style="background-color: #ffff00;"><b>imx6ull时钟相关的寄存器主要分布在</b></span><span style="color: #FF0000;"><span style="background-color: #ffff00;"><b>CCM</b></span></span><span style="background-color: #ffff00;"><b>和</b></span><span style="color: #FF0000;"><span style="background-color: #ffff00;"><b>ANALOG_DIG</b></span></span><span style="background-color: #ffff00;"><b>这两个模块</b></span>，它们均连接在<b>AIPS-1总线</b>上，它们的地址范围如下所示：</div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [6].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="811px"/><div><span style="background-color: #ffff00;"><b>ANALOG_DIG模块主要负责晶体振荡电路和锁相环电路的相关设置。</b></span></div><div>它的寄存器分为两类：</div><ol><li><div><b> CCM_ANALOG_PLL_xxx寄存器：</b></div></li></ol><div>设置对应PLL的参数和工作状态。</div><ol start="2"><li><div><b> CCM_ANALOG_MISCx （x = 0-2）寄存器：</b></div></li></ol><div>     进行其它一些杂项的设置或状态显示，包括晶体振荡电路的控制参数。这些寄存器数量较多，这里不一一列出。</div><div>     另外需要注意，<span style="color: #FF0000;"><b>ANALOG_DIG与电源管理模块（PMU）共用这些CCM_ANALOG_MISCx寄存器，它们在PMU中被称为PMU_MISCx （x = 0-2）</b></span>。由于晶体振荡电路在系统启动时已初始化完毕，输出频率固定的时钟信号，在芯片运行期间通常不需要修改设置，这里不再进行说明。</div><div>     <span style="background-color: #ffff00;"><b>而CCM模块控制根时钟信号的产生和分发，大部分寄存器用来对PLL及PFD产生的时钟信号进行分发和分频控制</b></span>，如下表所示：</div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [7].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="831px"/><div><br/></div><div>以及下面的表，<span style="color: #FF0000;">注意<b>红框部分</b>的寄存器CCM_CCGRx（x = 0-6），它们用来控制各个时钟信号在不同功耗模式下<b>是否被屏蔽</b>：</span></div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [8].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="831px"/><div><br/></div><h2><b>2.1 锁相环电路寄存器</b></h2><div>      如前所述，imx6ull共包含7个锁相环电路，<b>除ENET_PLL（PLL6）之外，其它的锁相环电路控制和状态寄存器的结构都很类似</b>。<span style="color: #FF0000;">以ARM_PLL为例</span>，它的寄存器结构如下所示：</div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [9].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="823px"/><div><br/></div><div>     其中，<b>控制位BYPASS、ENABLE和POWERDOWN用来控制PLL的工作模式（bypass模式、输出禁止模式和断电模式）</b>；<b>BYPASS_CLK_SRC选择</b><span style="color: #FF0000;"><b>输入时钟源</b></span>，<b>DIV_SELECT设置频率放大倍数</b>。<span style="color: #FF0000;"><b>正常工作时，需要设置BYPASS和POWRDOWN为0，ENABLE为1</b></span>。<span style="background-color: #ffff00;"><b>当LOCK值为1时，锁相环电路输出稳定的时钟信号</b></span>。</div><div><b> </b>    <b>稳定工作时，</b><span style="color: #FF0000;"><b>ARM_PLL的输出频率为 Fref * DIV_SELECT/2</b></span><b>，其它PLL的设置方法和输出频率计算公式与ARM_PLL类似，但略有差别。</b>例如，<span style="background-color: #ffff00;">锁相环电路USB1_PLL、USB2_PLL和SYS_PLL虽然都有自己的DIV_SELECT，它们应当被设为固定的值。</span></div><div>     需要特别说明的是，<span style="color: #FF0000;"><b>锁相环电路AUDIO_PLL和VIDEO_PLL还增加了额外的分频参数NUM和DENOM</b></span><b>。</b>以<b>AUDIO_PLL为例</b>，它的相应寄存器如下所示：</div><div><b>（1）CCM_ANALOG_PLL_AUDIO_NUM</b></div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [10].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="812px"/><div><b>（2）CCM_ANALOG_PLL_AUDIO_DENOM</b></div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [11].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="812px"/><div><br/></div><div>     它们的输出频率为<b>Fref * (DIV_SELECT + NUM/DENOM)</b>。除此之外，<span style="color: #FF0000;"><b>AUIDIO_PLL和VIDEO_PLL还可以在时钟切换电路（switcher）中设置额外的分频参数为/1、/2、/4、/8或/16</b></span>，这些值分布在寄存器<span style="background-color: #ffff00;">CCM_ANALOG_PLL_AUDIO、CCM_ANALOG_PLL_VIDEO和CCM_ANALOG_MISC2</span>中。</div><div>     除此之外，<span style="color: #FF0000;"><b>SYS_PLL和USB1_PLL还各自配有四个分相器，它们分别对SYS_PLL和USB1_PLL的输出时钟信号进行分频</b></span>，分频参数分别在<span style="background-color: #ffff00;">CCM_ANALOG_PFD_480n和CCM_ANALOG_PFD_528n</span>中设置。这两个寄存器的结构完全一样，如下图所示：</div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [12].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="816px"/><div><span style="background-color: #ffff00;"><b>每个PFD的输出频率为Fvco*18/PFD_FRAC</b></span>，其中<span style="color: #FF0000;">Fvco是相应PLL的输出频率，而PFD_FRAC的数值取值范围为12到35</span>。</div><h2><b>2.2 根时钟控制寄存器</b></h2><div>上述锁相环电路以及它们的bypass时钟信号、PFD输出信号，经过时钟切换电路（switcher）和根时钟生成电路（root generator）处理后形成各种根时钟信号。其中，<span style="background-color: #ffff00;"><b>时钟切换电路寄存器CCM_CCSR选择时钟信号pll1_sw_clk和pll3_sw_clk的来源</b></span><b>，如下图所示：</b></div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [13].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="825px"/><div><b>根时钟生成电路的寄存器也包含在CCM模块中</b>，比如<span style="background-color: #ffff00;"><b>ARM根时钟信号由pll1_sw_clk分频得来，相应的分频寄存器CCM_CACRR如下图所示</b></span>：</div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [14].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="825px"/><div><b>ARM的时钟信号频率为pll1_sw_clk/(ARM_PODF + 1)。</b></div><div>而之前提到的<span style="color: #FF0000;">总线根时钟信号由寄存器CCM_CBCDR进行选择和分频</span>，如下图所示：</div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [15].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="818px"/><div>其中各个字段的作用可参见根时钟信号电路一节中的原理图，具体设置步骤可参见后面的编程示例。其它根时钟的寄存器与其类似，详细的控制方式要参见imx6ull手册中CCM模块的寄存器描述，这里不再一一列举。</div><h2><b>2.3 模块时钟屏蔽寄存器（CCM Low Power Control Register）</b></h2><h3>2.3.1 IMX6ULL的三种工作方式</h3><div><b> </b>    <span style="color: #FF0000;"><b>为了降低功耗，imx6ull可以工作在以下三种模式：</b></span></div><ol><li><div><b>RUN模式：</b>CCM_CLPCR[LPM]的值为0，CPU正常工作，<span style="background-color: #ffff00;">各个模块的时钟信号可以在寄存器CCGRx中开启和关闭。</span></div></li><li><div><b>WAIT模式：</b>CCM_CLPCR[LPM]的值为1，当CPU执行WFI指令时，开始进入WAIT模式。<span style="background-color: #ffff00;">在此模式下，CPU时钟被关闭，依据寄存器CCGRx中的设置，相应模块的时钟信号也会被关闭。</span></div></li><li><div><b>STOP模式：</b>CCM_CLPCR[LPM]的值为2。<span style="background-color: #ffff00;">STOP模式同样重复上述WAIT模式的操作，并且禁用所有的PLL</span>。<b>如果设置了CCM_CLPCR[SBYOS]，该模式还将激活cosc_pwrdown信号，关闭晶体振荡电路的电源</b>。</div></li></ol><div><b> </b>   <span style="color: #FF0000;"> <b>对于每个时钟信号，imx6ull提供了在不同工作模式下是否屏蔽这些时钟信号的控制方法，这些控制位集中放在寄存器CCGRx（x = 0-6）中</b></span>，每个CCGRx寄存器结构如下图所示：</div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [16].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;" width="810px"/><div>  </div><div style="--en-callout:true;"><div>（<span style="color: #FF0000;"><b>注意这个寄存器默认值为11，即时钟信号在RUN和WAIT模式总是开启，在STOP模式中被屏蔽，所以在霞姐章节的笔记中，尚未有队时钟使能进行操作的代码</b></span>）</div></div><div>     每两位为一个单位，控制一个时钟信号。比如，在寄存器CCGR0中，CG15控制时钟信号gpio2_clocks，CG14控制时钟信号uart2_clock等等。这两位值的含义如下所示：</div><table align="center" cellpadding="0" cellspacing="0" style="--en-fitwindow:false;border-left:1px solid #d9d9d9;border-top:1px solid #d9d9d9;border-collapse:collapse;width:726px;" width="726px"><colgroup><col style="width: 262px;"></col><col style="width: 464px;"></col></colgroup><tbody><tr><td style="--en-typeInfo:{&quot;type&quot;:&quot;text&quot;,&quot;data&quot;:{}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><div>CGx （x=0-15）</div></td><td style="--en-typeInfo:{&quot;type&quot;:&quot;text&quot;,&quot;data&quot;:{}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><div>时钟信号活动状态描述</div></td></tr><tr><td style="--en-typeInfo:{&quot;type&quot;:&quot;text&quot;,&quot;data&quot;:{}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><div>00</div></td><td style="--en-typeInfo:{&quot;type&quot;:&quot;text&quot;,&quot;data&quot;:{}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><div>时钟信号在三个模式中均被屏蔽。</div></td></tr><tr><td style="--en-typeInfo:{&quot;type&quot;:&quot;text&quot;,&quot;data&quot;:{}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><div>01</div></td><td style="--en-typeInfo:{&quot;type&quot;:&quot;text&quot;,&quot;data&quot;:{}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><div>时钟信号仅在RUN模式开启，在其它模式中被屏蔽。</div></td></tr><tr><td style="--en-typeInfo:{&quot;type&quot;:&quot;text&quot;,&quot;data&quot;:{}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><div>10</div></td><td style="--en-typeInfo:{&quot;type&quot;:&quot;text&quot;,&quot;data&quot;:{}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><div>保留</div></td></tr><tr><td style="--en-typeInfo:{&quot;type&quot;:&quot;text&quot;,&quot;data&quot;:{}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><div>11</div></td><td style="--en-typeInfo:{&quot;type&quot;:&quot;text&quot;,&quot;data&quot;:{}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><div>时钟信号在RUN和WAIT模式开启，在STOP模式中被屏蔽。</div></td></tr></tbody></table><div>当用户某个模块驱动时，应当根据该模块是否需要在低功耗模式下工作来设置寄存器CCGRx中相应的值，以达到降低功耗的目的。另外，在正常工作模式中，用户也可以在模块空闲时将CCGRx中相应的值设为0，动态调节模块的功耗。</div><h1>三、个人理解</h1><div><b> </b>    <b>IMX6ULL的时钟源有两个：24M外部晶振和32.768K晶振，</b><span style="color: #FF0000;"><b>其中32.768K晶振用于内部RTC模块使用。24M外部晶振用于内核和各种外设使用，是时钟树的根源。</b></span></div><div style="padding-left:40px;"><span style="color: #000000;"><b>但是只有一个24M频率的时钟不足以供各种外设只用，因此，在24MHz的基础上，倍频分离出7路PLL时钟源</b></span></div><div style="padding-left:40px;text-align:center;"><span style="color: #000000;"><b>（图片来自芯片手册10.3.1章节）</b></span></div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [17].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;"/><div><b>  </b>    <b>在生成7路PLL和8路PFD后，系统产生了足够的时钟源，但是如何供给外设使用呢，这就需要CLOCK ROOT GENERATOR牵线搭桥。其作用就是根据实际需要，选择合适的时钟源，并对其进行分频，倍频，切换等工作，从而让外设拥有合适的时钟源。</b></div><div style="--en-blockquote:true;box-sizing: border-box; padding-left: 19px; padding-top: 6px; padding-bottom: 6px; border-left: 3px solid #b4c0cc; background-position: initial initial; background-repeat: initial initial; margin-top: 6px"><div>   <span style="color: #000000;"> <b>注意根据上面的图，将时钟树分成了三个部分，就是上面用红色框框出来的部分，</b></span><span style="color: #FF0000;"><span style="background-color: #ffff00;"><b>CLOCK SWITCHER，CLOCK ROOT GENERATOR，SYSTEM CLOCKS这三个部分</b></span></span><span style="color: #000000;"><b>。其中左边的 CLOCK_SWITCHER 就是我们前面所述的那 7 路 PLL 和8 路 PFD，右边的 SYSTEM CLOCKS 就是芯片外设，中间的 CLOCK ROOT GENERATOR 是最复杂的！这一部分就像“月老”一样， 给左边的CLOCK_SWITCHER和右边的SYSTEM CLOCKS进行牵线搭桥。外设时钟源是有多路可以选择的， CLOCK ROOT GENERATOR 就负责从 7 路PLL 和 8 路 PFD 中选择合适的时钟源给外设使用。</b></span></div></div><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/115a4be96dc64b48a07818d1f90e8e52.png" type="image/png" data-filename="115a4be96dc64b48a07818d1f90e8e52.png" style="--en-uploadstate:uploaded;"/><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/Image [18].png" type="image/png" data-filename="Image.png" style="--en-uploadstate:uploaded;"/><h2>4.1 <span style="color: #FF0000;"><span style="background-color: #ffff00;"><b>Switcher Clock Generation</b></span><b>  对应上图的Clock switcher部分</b></span></h2><img src="06 IMX6ULL裸机开发：IMX6ULL时钟体系_files/导出页面自 IMX6ULLRM.png" type="image/png" data-filename="导出页面自 IMX6ULLRM.png" style="--en-uploadstate:uploaded;"/><h1>四、参考文章</h1><div><a href="https://blog.csdn.net/qq_41971227/article/details/122332783?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1.no_search_link&amp;spm=1001.2101.3001.4242.2&amp;utm_relevant_index=4" rev="en_rl_none">时钟树分为三部分</a></div><div><a href="https://blog.csdn.net/weixin_43482414/article/details/104667812" rev="en_rl_none">https://blog.csdn.net/weixin_43482414/article/details/104667812</a></div><div><a href="https://blog.csdn.net/Pintitus/article/details/106182647" rev="en_rl_none">https://blog.csdn.net/Pintitus/article/details/106182647</a></div><div><br/></div></span>
</div></body></html> 